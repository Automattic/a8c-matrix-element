(window.webpackJsonp=window.webpackJsonp||[]).push([[32,36],{1586:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return P}));var a=n(103),r=n.n(a),o=n(106),c=n.n(o),i=n(93),s=n.n(i),l=n(99),d=n.n(l),u=n(917),m=n(94),b=n(96);function p(e){let{onCancelClick:t,onSaveClick:n,isSaveDisabled:a=!1}=e;return s.a.createElement("div",{className:"mx_EditWysiwygComposer_buttons"},s.a.createElement(b.a,{kind:"secondary",onClick:t},Object(m.a)("Cancel")),s.a.createElement(b.a,{kind:"primary",onClick:n,disabled:a},Object(m.a)("Save")))}var g=n(97),y=n(101),f=n(112),v=n(211),O=n(621),E=n(314),j=n(453),C=n(323);var h=n(105),T=n(454),k=n(924);var _=n(428),S=n(229),w=n(98);function x(e){const t=Object(f.c)(),n=Object(h.b)();return Object(i.useMemo)((()=>{if(e&&t.room)return function(e,t,n){const a=new S.a(t,n);let r;if(e.hasEditorState())r=e.getSerializedParts().map((e=>a.deserializePart(e)));else{if("org.matrix.custom.html"===e.getEvent().getContent().format)return function(e){var t;return(null===(t=e.getEvent().getContent().formatted_body)||void 0===t?void 0:t.replace(/<mx-reply>.*<\/mx-reply>/,""))||""}(e);r=Object(_.b)(e.getEvent(),a,{shouldEscape:w.b.getValue("MessageComposerInput.useMarkdown")})}return r.reduce(((e,t)=>e+t.text),"")}(e,t.room,n)}),[e,t,n])}const M=["editorStateTransfer","className"],R=Object(i.forwardRef)((function(e,t){let{disabled:n=!1,composerFunctions:a}=e;return function(e,t,n){const a=Object(f.c)(),r=Object(C.c)(),o=Object(i.useRef)(null),c=Object(i.useCallback)((c=>{var i;if(e||!t.current)return;const s=null!==(i=c.context)&&void 0!==i?i:f.a.Room;switch(c.action){case y.a.FocusEditMessageComposer:Object(O.a)(t,s,a,o);break;case y.a.ComposerInsert:if(c.timelineRenderingType!==a.timelineRenderingType)break;if(c.composerType!==E.a.Edit)break;c.text&&Object(j.b)(r.selection).then((()=>n.insertText(c.text)))}}),[e,t,n,o,a,r]);Object(v.a)(g.a,c)}(n,t,a),null}));function P(e){let{editorStateTransfer:t,className:n}=e,a=c()(e,M);const o=Object(i.useRef)(Object(C.b)()),l=x(t),m=!t||void 0!==l,{editMessage:b,endEditing:g,onChange:y,isSaveDisabled:v}=function(e,t){const n=Object(f.c)(),a=Object(h.b)(),[r,o]=Object(i.useState)(!0),[c,s]=Object(i.useState)(t);return{onChange:Object(i.useCallback)((e=>{s(e),o((n=>n&&e===t))}),[t]),editMessage:Object(i.useCallback)((()=>void 0!==c&&Object(k.editMessage)(c,{roomContext:n,mxClient:a,editorStateTransfer:e})),[c,n,a,e]),endEditing:Object(i.useCallback)((()=>Object(T.b)(n)),[n]),isSaveDisabled:r}}(t,l);return m?s.a.createElement(C.a.Provider,{value:o.current},s.a.createElement(u.a,r()({className:d()("mx_EditWysiwygComposer",n),initialContent:l,onChange:y,onSend:b},a),((e,t)=>s.a.createElement(s.a.Fragment,null,s.a.createElement(R,{disabled:a.disabled,ref:e,composerFunctions:t}),s.a.createElement(p,{onCancelClick:g,onSaveClick:b,isSaveDisabled:v}))))):null}},454:function(e,t,n){"use strict";n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return i}));var a=n(110),r=n(97),o=n(101);function c(e){r.a.dispatch({action:o.a.EditEvent,event:null,timelineRenderingType:e.timelineRenderingType}),r.a.dispatch({action:o.a.FocusSendMessageComposer,context:e.timelineRenderingType})}function i(e,t){const n=t.getEvent().replacingEvent();!n||n.status!==a.EventStatus.QUEUED&&n.status!==a.EventStatus.NOT_SENT||e.cancelPendingEvent(n)}},618:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var a=n(93),r=n.n(a),o=n(115),c=n(178),i=n(94);const s=e=>{let{name:t,last:n}=e;const a=o.g[t],c=o.a[t];return r.a.createElement(r.a.Fragment,null,r.a.createElement("kbd",null," ",a||c&&Object(i.a)(c)||t," "),!n&&"+")},l=e=>{let{value:t,className:n="mx_KeyboardShortcut"}=e;if(!t)return null;const a=[];return t.ctrlOrCmdKey?a.push(r.a.createElement(s,{key:"ctrlOrCmdKey",name:c.a?c.b.META:c.b.CONTROL})):t.ctrlKey?a.push(r.a.createElement(s,{key:"ctrlKey",name:c.b.CONTROL})):t.metaKey&&a.push(r.a.createElement(s,{key:"metaKey",name:c.b.META})),t.altKey&&a.push(r.a.createElement(s,{key:"altKey",name:c.b.ALT})),t.shiftKey&&a.push(r.a.createElement(s,{key:"shiftKey",name:c.b.SHIFT})),r.a.createElement("div",{className:n},a,r.a.createElement(s,{name:t.key,last:!0}))}},924:function(e,t,n){"use strict";n.r(t),n.d(t,"sendMessage",(function(){return T})),n.d(t,"editMessage",(function(){return k}));var a=n(106),r=n.n(a),o=n(136),c=n(162),i=n(98),s=n(427),l=n(246),d=n(223),u=n(284),m=n(97),b=n(351),p=n(454),g=n(6),y=n.n(g),f=n(622),v=n(110),O=n(199);function E(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function j(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?E(Object(n),!0).forEach((function(t){y()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):E(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}async function C(e,t,n){let{relation:a,replyToEvent:r,permalinkCreator:o,includeReplyLegacyFallback:c=!0,editedEvent:s}=n;const l=Boolean(s),d=l?Boolean(null==s?void 0:s.replyEventId):Boolean(r),u=l&&d,m=t?await Object(f.richToPlain)(e):e,b=u&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const n=t.split("\n").map((e=>e.trim()));return n.length>2&&n[0].startsWith("> ")&&0===n[1].length?`${n[0]}\n\n`:""}(s)||"",p=u&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const n=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return n&&n.outerHTML||""}(s)||"",g={msgtype:v.MsgType.Text,body:l?`${b} * ${m}`:m},y=i.b.getValue("MessageComposerInput.useMarkdown"),E=t?e:y?await Object(f.plainToRich)(e):null;E&&(g.format="org.matrix.custom.html",g.formatted_body=l?`${p} * ${E}`:E),l&&(g["m.new_content"]={msgtype:g.msgtype,body:m},E&&(g["m.new_content"].format="org.matrix.custom.html",g["m.new_content"].formatted_body=E));return function(e,t){t&&(e["m.relates_to"]=j(j({},e["m.relates_to"]||{}),t))}(g,l?j(j({},a),{},{rel_type:"m.replace",event_id:s.getId()}):a),!l&&r&&o&&Object(O.a)(g,r,{permalinkCreator:o,includeLegacyFallback:c}),g}const h=["roomContext","mxClient"];async function T(e,t,n){let{roomContext:a,mxClient:b}=n,p=r()(n,h);const{relation:g,replyToEvent:y}=p,{room:f}=a,v=null==f?void 0:f.roomId;if(!v)return;const O={eventName:"Composer",isEditing:!1,isReply:Boolean(y),inThread:(null==g?void 0:g.rel_type)===o.d.name};c.a.instance.trackEvent(O);const E=await C(e,t,p);if(!E.body.trim())return;i.b.getValue("Performance.addSendMessageTimingMetadata")&&Object(s.a)(E);const j=null!=g&&g.event_id&&(null==g?void 0:g.rel_type)===o.d.name?g.event_id:null,T=Object(l.a)(v,(e=>b.sendMessage(e,j,E)),b);return y&&m.a.dispatch({action:"reply_to_event",event:null,context:a.timelineRenderingType}),m.a.dispatch({action:"message_sent"}),d.CHAT_EFFECTS.forEach((e=>{if(Object(u.containsEmoji)(E,e.emojis)){const t=(null==g?void 0:g.rel_type)!==o.d.name;i.b.getValue("feature_threadenabled")&&!t||m.a.dispatch({action:`effects.${e.command}`})}})),i.b.getValue("Performance.addSendMessageTimingMetadata")&&T.then((e=>{Object(s.b)(b,v,e.event_id)})),i.b.getValue("scrollToBottomOnMessageSent")&&m.a.dispatch({action:"scroll_to_bottom",timelineRenderingType:a.timelineRenderingType}),T}async function k(e,t){let{roomContext:n,mxClient:a,editorStateTransfer:r}=t;const o=r.getEvent();c.a.instance.trackEvent({eventName:"Composer",isEditing:!0,inThread:Boolean(null==o?void 0:o.getThread()),isReply:Boolean(o.replyEventId)});const i=await C(e,!0,{editedEvent:o}),s=i["m.new_content"];if(""===(null==s?void 0:s.body))return Object(p.a)(a,r),void Object(b.a)({mxEvent:o,onCloseDialog:()=>{Object(p.b)(n)}});let l;const d=o.getRoomId();if(function(e,t){const n=t.getEvent().getContent();return n.msgtype!==e.msgtype||n.body!==e.body||n.format!==e.format||n.formatted_body!==e.formatted_body}(s,r)&&d){Object(p.a)(a,r);const e=r.getEvent().threadRootId||null;l=a.sendMessage(d,e,i),m.a.dispatch({action:"message_sent"})}return Object(p.b)(n),l}}}]);
//# sourceMappingURL=32.js.map